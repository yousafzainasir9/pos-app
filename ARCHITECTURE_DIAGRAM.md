# ğŸ—ï¸ Architecture Improvements Diagram

## Before vs After Architecture

### BEFORE - Old Structure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           WebAPI Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AuthController.cs                    â”‚  â”‚
â”‚  â”‚  â€¢ DTOs defined in controller âŒ      â”‚  â”‚
â”‚  â”‚  â€¢ Generic error handling âŒ          â”‚  â”‚
â”‚  â”‚  â€¢ Plain text tokens âŒ               â”‚  â”‚
â”‚  â”‚  â€¢ Magic numbers âŒ                   â”‚  â”‚
â”‚  â”‚  â€¢ No rate limiting âŒ                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Application Layer                    â”‚
â”‚  â€¢ No validators âŒ                         â”‚
â”‚  â€¢ No custom exceptions âŒ                  â”‚
â”‚  â€¢ No constants âŒ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Infrastructure Layer                  â”‚
â”‚  â€¢ No security service âŒ                   â”‚
â”‚  â€¢ Basic data access only                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Domain Layer                       â”‚
â”‚  â€¢ User entity (RefreshToken plain) âŒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AFTER - Improved Structure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           WebAPI Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Configuration/                       â”‚  â”‚
â”‚  â”‚  â””â”€â”€ RateLimitOptions.cs âœ…           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Middleware/                          â”‚  â”‚
â”‚  â”‚  â””â”€â”€ ExceptionHandlingMiddleware âœ…   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Controllers/                         â”‚  â”‚
â”‚  â”‚  â””â”€â”€ AuthController.cs                â”‚  â”‚
â”‚  â”‚      â€¢ Uses DTOs from App layer âœ…    â”‚  â”‚
â”‚  â”‚      â€¢ Typed exceptions âœ…            â”‚  â”‚
â”‚  â”‚      â€¢ Security service âœ…            â”‚  â”‚
â”‚  â”‚      â€¢ Constants âœ…                   â”‚  â”‚
â”‚  â”‚      â€¢ Rate limiting âœ…               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Application Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  DTOs/Auth/                           â”‚  â”‚
â”‚  â”‚  â€¢ LoginRequestDto âœ…                 â”‚  â”‚
â”‚  â”‚  â€¢ PinLoginRequestDto âœ…              â”‚  â”‚
â”‚  â”‚  â€¢ RefreshTokenRequestDto âœ…          â”‚  â”‚
â”‚  â”‚  â€¢ LoginResponseDto âœ…                â”‚  â”‚
â”‚  â”‚  â€¢ UserDto âœ…                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Validators/Auth/                     â”‚  â”‚
â”‚  â”‚  â€¢ LoginRequestValidator âœ…           â”‚  â”‚
â”‚  â”‚  â€¢ PinLoginRequestValidator âœ…        â”‚  â”‚
â”‚  â”‚  â€¢ RefreshTokenRequestValidator âœ…    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Common/Constants/                    â”‚  â”‚
â”‚  â”‚  â€¢ AuthConstants âœ…                   â”‚  â”‚
â”‚  â”‚  â€¢ ErrorCodes âœ…                      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Common/Exceptions/                   â”‚  â”‚
â”‚  â”‚  â€¢ ApplicationException âœ…            â”‚  â”‚
â”‚  â”‚  â€¢ AuthenticationException âœ…         â”‚  â”‚
â”‚  â”‚  â€¢ ValidationException âœ…             â”‚  â”‚
â”‚  â”‚  â€¢ NotFoundException âœ…               â”‚  â”‚
â”‚  â”‚  â€¢ BusinessRuleException âœ…           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Common/Models/                       â”‚  â”‚
â”‚  â”‚  â€¢ ApiResponse<T> âœ…                  â”‚  â”‚
â”‚  â”‚  â€¢ ErrorResponse âœ…                   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Interfaces/                          â”‚  â”‚
â”‚  â”‚  â€¢ ISecurityService âœ…                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Infrastructure Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Services/Security/                   â”‚  â”‚
â”‚  â”‚  â€¢ SecurityService âœ…                 â”‚  â”‚
â”‚  â”‚    - HashToken()                      â”‚  â”‚
â”‚  â”‚    - VerifyToken()                    â”‚  â”‚
â”‚  â”‚    - GenerateSecureToken()            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Domain Layer                       â”‚
â”‚  â€¢ User entity                              â”‚
â”‚    - RefreshToken (now stores hash) âœ…      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow - Authentication

### Login Request Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/auth/login
       â”‚ { username, password }
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rate Limiting Middleware            â”‚
â”‚  â€¢ Check: < 5 attempts in 5 min? âœ…  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ (if allowed)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Exception Handling Middleware       â”‚
â”‚  â€¢ Wraps entire request              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FluentValidation                    â”‚
â”‚  â€¢ Validate username (3-50 chars) âœ… â”‚
â”‚  â€¢ Validate password (min 6 chars) âœ…â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ (if valid)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthController.Login()              â”‚
â”‚  1. Query user from database         â”‚
â”‚  2. Verify password (BCrypt)         â”‚
â”‚  3. Generate JWT token               â”‚
â”‚  4. Generate refresh token           â”‚
â”‚  5. Hash refresh token (SHA256) âœ…   â”‚
â”‚  6. Store hash in database âœ…        â”‚
â”‚  7. Return token to client           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ (success)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ApiResponse<LoginResponseDto>       â”‚
â”‚  {                                   â”‚
â”‚    success: true,                    â”‚
â”‚    data: {                           â”‚
â”‚      token: "eyJ...",                â”‚
â”‚      refreshToken: "plain",          â”‚
â”‚      user: { ... }                   â”‚
â”‚    }                                 â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â”‚ (stores both)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Error Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/auth/login
       â”‚ { username: "wrong", password: "wrong" }
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthController.Login()              â”‚
â”‚  â€¢ User not found or password wrong  â”‚
â”‚  â€¢ throw AuthenticationException     â”‚
â”‚    .InvalidCredentials() âœ…          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ (exception thrown)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Exception Handling Middleware       â”‚
â”‚  â€¢ Catch AuthenticationException     â”‚
â”‚  â€¢ Extract error code: AUTH_001 âœ…   â”‚
â”‚  â€¢ Extract message âœ…                â”‚
â”‚  â€¢ Create ErrorResponse âœ…           â”‚
â”‚  â€¢ Set status: 401 âœ…               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ApiResponse (Error)                 â”‚
â”‚  {                                   â”‚
â”‚    success: false,                   â”‚
â”‚    error: {                          â”‚
â”‚      errorCode: "AUTH_001",          â”‚
â”‚      message: "Invalid credentials", â”‚
â”‚      timestamp: "2025-01-04..."      â”‚
â”‚    }                                 â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â”‚ (shows error)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Flow - Token Hashing

### Token Generation & Storage
```
Client                AuthController          SecurityService         Database
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚   Login Request         â”‚                       â”‚                    â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚                         â”‚  GenerateSecureToken()â”‚                    â”‚
  â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚                         â”‚  "abc123xyz..." â—„â”€â”€â”€â”€â”€â”‚                    â”‚
  â”‚                         â”‚  (plain token)        â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚                         â”‚  HashToken(token)     â”‚                    â”‚
  â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚                         â”‚  "7f3e9..." â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
  â”‚                         â”‚  (SHA256 hash)        â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚                         â”‚  Store hash           â”‚                    â”‚
  â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚                       â”‚    RefreshToken    â”‚
  â”‚                         â”‚                       â”‚    = "7f3e9..."    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚  Response               â”‚                       â”‚                    â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                    â”‚
  â”‚  { token: "...",        â”‚                       â”‚                    â”‚
  â”‚    refreshToken:        â”‚                       â”‚                    â”‚
  â”‚    "abc123xyz..." }     â”‚                       â”‚                    â”‚
  â”‚  (plain to client)      â”‚                       â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚

Client stores plain token
Database stores hash âœ…

If database is breached:
âŒ Before: Attacker gets plain tokens
âœ… After:  Attacker only gets hashes (useless)
```

### Token Verification
```
Client                AuthController          SecurityService         Database
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚  Refresh Request        â”‚                       â”‚                    â”‚
  â”‚  { refreshToken:        â”‚                       â”‚                    â”‚
  â”‚    "abc123xyz..." }     â”‚                       â”‚                    â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚                         â”‚  HashToken(token)     â”‚                    â”‚
  â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚                         â”‚  "7f3e9..." â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚                         â”‚  Find user by hash    â”‚                    â”‚
  â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚                       â”‚  WHERE             â”‚
  â”‚                         â”‚                       â”‚  RefreshToken      â”‚
  â”‚                         â”‚                       â”‚  = "7f3e9..." âœ…   â”‚
  â”‚                         â”‚  User found â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                         â”‚                       â”‚                    â”‚
  â”‚  New tokens             â”‚                       â”‚                    â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                    â”‚
  â”‚                         â”‚                       â”‚                    â”‚
```

---

## Rate Limiting Flow

### Normal Usage (< 5 attempts)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚ Attempt 1
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rate Limiter                â”‚
â”‚  Attempts: 1/5 âœ…            â”‚
â”‚  Window: 5 minutes           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ Allow
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthControllerâ”‚
â”‚  Process loginâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ Attempt 2
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rate Limiter                â”‚
â”‚  Attempts: 2/5 âœ…            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ Allow
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthControllerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rate Limit Exceeded (> 5 attempts)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚ Attempt 6 (within 5 min)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rate Limiter                â”‚
â”‚  Attempts: 6/5 âŒ            â”‚
â”‚  BLOCKED!                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ Reject
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP 429 Too Many Requests  â”‚
â”‚  {                           â”‚
â”‚    error: "Rate limit..."    â”‚
â”‚    retryAfter: 300s          â”‚
â”‚  }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client    â”‚
â”‚ Must wait  â”‚
â”‚ 5 minutes  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Validation Flow

### With FluentValidation
```
Request: { username: "ab", password: "123" }
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LoginRequestValidator                â”‚
â”‚  â€¢ Username min 3 chars âŒ            â”‚
â”‚  â€¢ Password min 6 chars âŒ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ (validation fails)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ValidationException                  â”‚
â”‚  Errors: {                            â”‚
â”‚    "Username": [                      â”‚
â”‚      "must be at least 3 characters"  â”‚
â”‚    ],                                 â”‚
â”‚    "Password": [                      â”‚
â”‚      "must be at least 6 characters"  â”‚
â”‚    ]                                  â”‚
â”‚  }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Exception Handling Middleware        â”‚
â”‚  â€¢ Catch ValidationException          â”‚
â”‚  â€¢ Create ErrorResponse               â”‚
â”‚  â€¢ Status: 400 Bad Request            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ApiResponse (Error)                  â”‚
â”‚  {                                    â”‚
â”‚    success: false,                    â”‚
â”‚    error: {                           â”‚
â”‚      errorCode: "VAL_001",            â”‚
â”‚      message: "Validation failed",    â”‚
â”‚      errors: {                        â”‚
â”‚        "Username": ["..."],           â”‚
â”‚        "Password": ["..."]            â”‚
â”‚      }                                â”‚
â”‚    }                                  â”‚
â”‚  }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
    Client
    (shows field-specific errors)
```

---

## Files Organization

```
POS Application
â”‚
â”œâ”€â”€ Domain (Entities, Enums)
â”‚   â””â”€â”€ User.cs âœ… (documented RefreshToken field)
â”‚
â”œâ”€â”€ Application (Business Logic)
â”‚   â”œâ”€â”€ DTOs/Auth/ âœ…
â”‚   â”‚   â”œâ”€â”€ LoginRequestDto
â”‚   â”‚   â”œâ”€â”€ PinLoginRequestDto
â”‚   â”‚   â”œâ”€â”€ RefreshTokenRequestDto
â”‚   â”‚   â”œâ”€â”€ LoginResponseDto
â”‚   â”‚   â””â”€â”€ UserDto
â”‚   â”‚
â”‚   â”œâ”€â”€ Validators/Auth/ âœ…
â”‚   â”‚   â”œâ”€â”€ LoginRequestValidator
â”‚   â”‚   â”œâ”€â”€ PinLoginRequestValidator
â”‚   â”‚   â””â”€â”€ RefreshTokenRequestValidator
â”‚   â”‚
â”‚   â”œâ”€â”€ Common/
â”‚   â”‚   â”œâ”€â”€ Constants/ âœ…
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthConstants
â”‚   â”‚   â”‚   â””â”€â”€ ErrorCodes
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Exceptions/ âœ…
â”‚   â”‚   â”‚   â”œâ”€â”€ ApplicationException
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthenticationException
â”‚   â”‚   â”‚   â”œâ”€â”€ ValidationException
â”‚   â”‚   â”‚   â”œâ”€â”€ NotFoundException
â”‚   â”‚   â”‚   â””â”€â”€ BusinessRuleException
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Models/ âœ…
â”‚   â”‚       â”œâ”€â”€ ApiResponse<T>
â”‚   â”‚       â””â”€â”€ ErrorResponse
â”‚   â”‚
â”‚   â””â”€â”€ Interfaces/ âœ…
â”‚       â””â”€â”€ ISecurityService
â”‚
â”œâ”€â”€ Infrastructure (Data Access, Services)
â”‚   â””â”€â”€ Services/Security/ âœ…
â”‚       â””â”€â”€ SecurityService
â”‚
â””â”€â”€ WebAPI (Controllers, Middleware)
    â”œâ”€â”€ Configuration/ âœ…
    â”‚   â””â”€â”€ RateLimitOptions
    â”‚
    â”œâ”€â”€ Middleware/ âœ…
    â”‚   â””â”€â”€ ExceptionHandlingMiddleware
    â”‚
    â””â”€â”€ Controllers/
        â””â”€â”€ AuthController âœ… (updated)
```

---

## Summary of Improvements

### Security: ğŸ”´ â†’ ğŸŸ¢
- âœ… Token hashing (SHA256)
- âœ… Rate limiting (5/5min)
- âœ… Input validation
- âœ… Secure token generation

### Code Quality: ğŸŸ¡ â†’ ğŸŸ¢
- âœ… Clean architecture
- âœ… Typed exceptions
- âœ… Constants (no magic numbers)
- âœ… Proper layer separation

### Maintainability: ğŸŸ¡ â†’ ğŸŸ¢
- âœ… Reusable validators
- âœ… Centralized error codes
- âœ… Consistent API responses
- âœ… Comprehensive documentation

### Developer Experience: ğŸŸ¡ â†’ ğŸŸ¢
- âœ… Clear error messages
- âœ… Easy to extend
- âœ… Well documented
- âœ… Testing ready
